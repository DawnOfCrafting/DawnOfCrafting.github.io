<div id="gameDiv" style="width: 100%; text-align:center">
	<!-- <div id="game" style="width:800px;height:500px margin:0 auto;">
		<canvas id="ctx" width="500" height="500" style="position:absolute;border:1px solid #000000;"></canvas>
	</div> -->
</div>

<style type="text/css">
    /*.button{
        background: url(./img/craftbutton.png) no-repeat;
        background-size: contain;
        cursor:pointer;
        border: none;
        width: 150px;
	    height: 150px;
	    position: absolute;
    }*/
</style>

<!-- <div id="craftTable">
	
	<img id="crafttable" src="./img/crafttable.png" style="position:absolute">
	<button id="craftbutton" type="button" class="button">Click Me!</button>
	<button id="storage" type="button" class="button"></button>
	<img src="./img/craftbutton.png" style="position:absolute">
	<img src="./img/storage.png" style="position:absolute">
</div> -->

<script src="./items.js"></script>
<script src="./storage.js"></script>

<script>
	//General
	var SIDESIZE = 60;
	var PADDING = 30;
	var canvasSize = Math.min(window.innerWidth *3/4, window.innerHeight *3/4)
	var canvasWidth = canvasSize
	var canvasHeight = canvasSize
	var playerFoundRecipes = {}

	//Canvas & BG
	var gameDiv = document.getElementById('gameDiv')
	var Canvas = function() {
		var canvas = document.createElement('canvas')
		var ctx = canvas.getContext("2d")
	    canvas.width = canvasWidth
	    canvas.height = canvasHeight
	    canvas.style = "position:absolute; border:1px solid #000000;top:0;left:0;"
	    gameDiv.appendChild(canvas)
	    return ctx
	}
	var ctxBg = Canvas()
	// drawBackground(ctxBg)
	var ctx = Canvas()

	//Recipe List
	var recipeList = document.createElement('div')
	recipeList.style = "overflow-y: scroll;position:absolute; border:1px solid #000000;width:300;height:" + canvasHeight + ";top:0; left:" + canvasWidth
	gameDiv.appendChild(recipeList)

	var recipes = Item.getCraftableList()
	refreshRecipes()

	function refreshRecipes() {
		while (recipeList.firstChild) {
		    recipeList.removeChild(recipeList.firstChild);
		}
		var title = document.createElement('h2')
		title.innerHTML = "Recipe List"
		recipeList.appendChild(title)
		
		for(var i in recipes) {
			var recipe = document.createElement('span')
			if(playerFoundRecipes[recipes[i].id]) {
				recipe.style = "color: #00ff00"
			} else {
				recipe.style = "color: #ff0000"	
			}
			recipeList.appendChild(recipe)
			var text = ""
			for(var k in recipes[i].inputs) {
				if(k != 0) {
					text += " + "
				}
				text += recipes[i].inputs[k].name + '(' + recipes[i].inputs[k].amount + ')'
			}
			text += " = "
			text += recipes[i].name
			recipe.innerHTML += text + '<br><br>'
		}
	}
	
	// Init Storagees
	var wildStorage = Storage(
		0,
		0,
		canvasWidth,
		canvasHeight/3,
		'./img/forest.png'
	)
    var playerStorage = Storage(
    	0,
    	canvasHeight/3,
    	canvasWidth,
    	canvasHeight/3,
    	'./img/storage.png'
    )
    var craftTableInputStorage = Storage(
		PADDING,
		canvasHeight*2/3 + PADDING,
		canvasWidth/4,
		canvasHeight/3 - PADDING*2,
		'./img/storage.png'
	)
	var craftTableOutputStorage = Storage(
		canvasWidth/4 + PADDING * 2,
		canvasHeight*2/3 + PADDING,
		canvasWidth/4,
		canvasHeight/3 - PADDING*2,
		'./img/storage.png'
	)

    // Init Craft Table
    var crafTableImg = new Image()
    crafTableImg.src = './img/crafttable.png'
    var craftButtonImg = new Image()
    craftButtonImg.src = './img/craftbutton.png'

    var craftTable = Entity(crafTableImg,0,canvasHeight*2/3,canvasWidth,canvasHeight/3)
    var craftbutton = Entity(craftButtonImg,canvasWidth*3/4 - PADDING,canvasHeight*2/3 + PADDING,canvasWidth/4,canvasHeight/3 - PADDING * 2,'Craft')

    //Game Loop & Draw
    setInterval(function(){
		ctx.clearRect(0,0,canvasWidth,canvasHeight);
		ctxBg.clearRect(0,0,canvasWidth,canvasHeight);
		generateRandomItem()

		drawStorage(ctxBg, wildStorage)
		drawStorage(ctxBg, playerStorage)
		drawCraftTable(craftTable)
		drawCraftTable(craftbutton)
		drawStorage(ctxBg, craftTableInputStorage)
		drawStorage(ctxBg, craftTableOutputStorage)
		
		drawItemsInStorage(wildStorage)
		drawItemsInStorage(playerStorage)
		drawItemsInStorage(craftTableInputStorage)
		drawItemsInStorage(craftTableOutputStorage)
	},40);

    function drawCraftTable(entity) {
	    ctxBg.drawImage(entity.image,entity.x,entity.y,entity.w,entity.h)
	    if(entity.title) {
		    ctxBg.fillStyle = 'black'
			ctxBg.stroke()
			ctxBg.font = '50px Arial';
			ctxBg.fillText(entity.title,entity.x + PADDING/2,entity.y + entity.h/2 + PADDING/2)
	    }
    }
    function drawStorage(ctx, storage) {
    	var img = new Image()
	    img.src = storage.image
    	// context.drawImage(img,sx,sy,swidth,sheight,x,y,width,height);
    	ctx.drawImage(img,storage.x,storage.y,storage.w,storage.h)
    }
    function drawItemsInStorage(storage) {
		for(var i in storage.items) {
    		var item = storage.items[i]
    		var image = new Image()
    		image.src = item.image
    		// console.log("item is " + item.name + " x: " + item.x + " amount: " + item.amount)
    		ctx.drawImage(image,item.x,item.y,SIDESIZE,SIDESIZE)
    		ctx.fillStyle = 'white'
    		ctx.stroke()
			ctx.fillText(item.amount,item.x,item.y)
    	}
	}
    
    //Generating Items
    var generateCount = 0
    function generateRandomItem() {
    	generateCount += 1
    	if(generateCount % 25 == 0) {
    		var itemList = Item.getGatherableList()
    		var randomItem = itemList[getRandomInt(0, itemList.length)]
    		wildStorage.addItem(randomItem, SIDESIZE)
    		generateCount = 0
    	}
    }

    // Tap Actions
    function mouseOnPos(position) {
    	if(searchAndAddToStorage(wildStorage,playerStorage,0,position)) { return }
    }

    function mouseTappedPos(position) {    	
    	if(searchAndAddToStorage(playerStorage,craftTableInputStorage,1,position)) { return }
    	if(searchAndAddToStorage(craftTableInputStorage, playerStorage,1,position)) { return }
    	if(searchAndAddToStorage(craftTableOutputStorage, playerStorage,0,position)) { return }

		if(isInBounds(position,craftbutton)) {
			var itemList = Item.getCraftableList() 
			for(var i in itemList) {
				if(itemList[i].craftThis(craftTableInputStorage, craftTableOutputStorage)) {
					playerFoundRecipes[itemList[i].id] = itemList[i]
					refreshRecipes()
					return
				} 
			}
		}
	}

	function isInBounds(position,item) {
		if(position.x >= item.x &&
			position.x <= item.x + item.w &&
			position.y >= item.y &&
			position.y <= item.y + item.h) {
			return true
		}
		return false
	}

	function searchAndAddToStorage(fromSt,toSt,amount,position) { //fromStorage, toStorage
		for(var i in fromSt.items) {
			if(isInBounds(position,fromSt.items[i])){
				if(amount != 1) {
					amount = fromSt.items[i].amount
				}
				toSt.addItemFromThisStorage(fromSt,fromSt.items[i],amount,SIDESIZE)
				return true
			}
		}
		return false
	}

	function isClose(p1,p2) {
		var d = Math.hypot(p2.x-p1.x, p2.y-p1.y)
		if(d > SIDESIZE){
			return false
		}
		return true
	}

    function getRandomInt(min, max) {
	    min = Math.ceil(min);
	    max = Math.floor(max);
	    return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
	}

	var mouseDownLoc = null
	var dragging = false //didnt implement dragging feature
	ctx.canvas.addEventListener("mousedown", function (e) {
		mouseDownLoc = getMousePos(ctx.canvas, e)
	}, false)

	ctx.canvas.addEventListener("mouseup", function (e) {
		if(isClose(getMousePos(ctx.canvas, e),mouseDownLoc)){
			mouseTappedPos(getMousePos(ctx.canvas, e))
		}
	}, false)

	ctx.canvas.addEventListener("mousemove", function (e) {
		drawing = true;
		mouseOnPos(getMousePos(ctx.canvas, e))
	}, false)

	// Get the position of the mouse relative to the canvas
	function getMousePos(canvasDom, mouseEvent) {
		var rect = canvasDom.getBoundingClientRect();
		return {
			x: mouseEvent.clientX - rect.left,
			y: mouseEvent.clientY - rect.top
		};
	}
	
	document.onmousedown = function(event){
		// console.log("On Moust Down")
		// console.log(event)
		// socket.emit('keyPress',{inputId:'attack',state:true});
	}
	document.onmouseup = function(event){
		// socket.emit('keyPress',{inputId:'attack',state:false});
	}
	document.onmousemove = function(event){
		// var x = -250 + event.clientX - 8;
		// var y = -250 + event.clientY - 8;
		// var angle = Math.atan2(y,x) / Math.PI * 180;
	}
	
	document.oncontextmenu = function(event){
		// event.preventDefault();
	}
	
	
	
</script>





